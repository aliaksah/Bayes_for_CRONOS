---
title: "Task 1"
output: html_notebook
---

# Load single imputed PISA data and prepare it, thus build PISA scales.

```{r}
source("packages.r")
load(file = file.path("IMPDAT_PISA.RData"))
source("01data_preperation.r")
to.rm <- objects()[!objects() %in% c("PPath","pisa18","countries")]
rm(list = to.rm)
head(pisa18)

```

# There should be at least ten students per school. Schools with fewer observations are 
# excluded from the analysis. The variable nb.stud informs about the number of stundets
# per school

```{r}
tab.id <- table(pisa18$school.id)
id.frame <- as.data.frame(tab.id)

nb.stud <- rep(id.frame$Freq,id.frame$Freq)
pisa18$nb.stud <- nb.stud
rm(tab.id,id.frame,nb.stud)
pisa.data <- subset(pisa18, pisa18$nb.stud > 9)
pisa18 <- pisa.data

rm(pisa.data)
summary(pisa18$nb.stud)
```

# Only one row per school, remove duplicated rows. The data set has one row for each school, there are 284 schools in der data set.

```{r}
pisa18_sc <- pisa18[!duplicated(pisa18$school.id), ]
rm(pisa18)
View(pisa18_sc)

dim(pisa18_sc)
```
```{r}
library("rstanarm")
library("betareg")
a.seed <- 12345 
a.iter <-  2000 
a.chains <- 4  
data <- pisa18_sc[, -which(names(pisa18_sc) %in% c("school.id","CNT","nb.stud"))]

#' @title Transforms from the probability to the logit scale
#' @description Transforms from the probability to the logit scale
#' @param logit The probability 
#' @return The corresponding value on the logit scale
logit <- function(p = p){
  r <- log(p/(1 - p))
  return(r)
}

data$LDFRAC_L <- logit(data$LDFRAC + 0.001)



```
# stan beta_reg: https://cran.r-project.org/web/packages/rstanarm/vignettes/betareg.html

```{r}
fits <- list()
fits[[1]] <- stan_glm(LDFRAC_L ~ DISHOME, data = data, seed = a.seed,
                      iter = a.iter, chains = a.chains, family = gaussian(link = "identity"))

fits[[2]] <- stan_glm(LDFRAC_L ~ BULL, data = data, seed = a.seed,
                      iter = a.iter, chains = a.chains, family = gaussian(link = "identity"))

fits[[3]] <- stan_glm(LDFRAC_L ~ STAFFLACK, data = data, seed = a.seed,
                      iter = a.iter, chains = a.chains, family = gaussian(link = "identity"))
loo_list <- list()
# Compute loo

loo_list <- lapply(fits, loo, cores = 1)
```

# Compute the stacking weights

```{r}
wtsStacking <- list()

wtsStacking <- loo_model_weights(loo_list, method = "stacking")
print(wtsStacking)
```

